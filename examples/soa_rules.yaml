# SOA Rules - SMOS10HV Process
# YAML Format for SOA Rule Specification

version: "1.0"
process: "SMOS10HV"
date: "2025-12-08"

# =============================================================================
# Global Configuration
# =============================================================================
global:
  timing:
    tmin: 0                    # Minimum violation time before warning
    tdelay: 0                  # Delay after transient start
    vballmsg: 1.0              # Message verbosity
    stop: 0                    # Stop simulation on violation
  
  temperature:
    tcelsius0: 273.15
    tref_soa: 25
  
  tmaxfrac:
    level0: 0                  # 0% - No violations allowed
    level1: 0.01               # 1% - Violations allowed 1% of time
    level2: 0.10               # 10% - Violations allowed 10% of time
    level3: -1                 # Review required
  
  limits:
    ap_fwd_ref: 0.9943
    ap_fwd_T: -0.0006
    ap_fwd: "ap_fwd_ref + ap_fwd_T * (temp - tref_soa)"
    ap_no_check: 999.00
    ap_gc_lv: 1.65
    ap_gc_hv: 5.5
    ap_fwd_hv: 1.2
    ap_gc_lv_oxrisk: 1.32
    ap_gc_hv_oxrisk: 4.4
    dtmax_rm: 5
    theat: 1.0e-7

# =============================================================================
# SOA Rules
# =============================================================================
rules:
  
  # Simple Voltage Constraint
  - name: "NMOS Core VDS Simple Limit"
    device: nmos_core
    parameter: "v[d,s]"
    type: vhigh
    severity: high
    constraint:
      vhigh: 1.65
    description: "Drain-source voltage must not exceed 1.65V"
  
  - name: "PMOS Core VDS Simple Limit"
    device: pmos_core
    parameter: "v[d,s]"
    type: vhigh
    severity: high
    constraint:
      vhigh: 2.08
    description: "Drain-source voltage must not exceed 2.08V"
  
  # Temperature-Dependent Constraint
  - name: "Diode Temperature Dependent Voltage"
    device: dz5
    parameter: "v[p,n]"
    type: vhigh
    severity: review
    constraint:
      vhigh: "0.9943 - 0.0006*(T - 25)"
    description: "Forward voltage limit decreases with temperature"
  
  - name: "Junction Temperature Dependent"
    device: nmos_core
    parameter: "v[s,b]"
    type: vlow
    severity: high
    constraint:
      vlow: "ap_fwd_ref + ap_fwd_T * (T - tref_soa)"
    description: "Source-bulk junction forward bias limit"
  
  # Multi-Pin with Functions
  - name: "Diode Multi-Pin with Min Function"
    device: dz5
    parameter: "v[n,p]"
    type: vlow
    severity: review
    constraint:
      vlow: "min(90, 90 + v[p] - v[sub])"
    description: "Reverse voltage limited by substrate potential"
  
  - name: "HV Device Substrate Dependent"
    device: nmos90_10hv
    parameter: "v[d,sub]"
    type: vhigh
    severity: high
    constraint:
      vhigh: "max(70, min(120, 90 + v[sub]))"
    description: "Drain-substrate voltage with substrate tracking"
  
  # Current with Device Parameters
  - name: "Poly Resistor Current Width Dependency"
    device: poly_10hv
    parameter: "i[poly_10hv]"
    type: ihigh
    severity: low
    constraint:
      ihigh: "$w * $np * 2.12e-4"
    description: "Maximum current scales with width and number of parallel segments"
  
  - name: "Metal Resistor DC Current"
    device: rm1_10hv
    parameter: "i[rm1_10hv]"
    type: ihigh
    severity: high
    constraint:
      ihigh: "$w * 4.05e-3"
    description: "DC current density limit for metal-1 resistor"
  
  # Conditional Logic
  - name: "BJT Conditional Voltage Limit"
    device: npn_b
    parameter: "v[c,e]"
    type: vhigh
    severity: high
    constraint:
      vhigh: "if T > 85 then 10.0 else 12.0"
    description: "Collector-emitter voltage reduced at high temperature"
  
  - name: "NMOS Gate Oxide Conditional"
    device: nmos_5v
    parameter: "v[g,s]"
    type: vhigh
    severity: medium
    constraint:
      vhigh: "if T < 0 then 5.0 else 5.5"
    description: "Gate-source voltage reduced at low temperature"
  
  # Multi-Level (tmaxfrac)
  - name: "NMOS Core Multi-Level VDS"
    device: nmos_core
    parameter: "v[d,s]"
    type: vhigh
    severity: low
    constraint:
      vhigh: 1.65
    tmaxfrac:
      0.0: 1.65      # Never exceed 1.65V
      0.01: 1.84     # Can exceed to 1.84V for 1% of time
      0.1: 1.71      # Can exceed to 1.71V for 10% of time
    description: "Drain-source voltage with time-dependent relaxation"
  
  - name: "PMOS Core Multi-Level VDS"
    device: pmos_core
    parameter: "v[d,s]"
    type: vhigh
    severity: low
    constraint:
      vhigh: 1.65
    tmaxfrac:
      0.0: 1.65
      0.01: 1.89
      0.1: 2.07
    description: "Drain-source voltage with time-dependent relaxation"
  
  # MOS State-Dependent
  - name: "NMOS Core State Dependent"
    device: nmos_core
    parameter: "v[d,s]"
    type: state_dependent
    severity: high
    constraint:
      vhigh_on: 1.84      # When device is ON (Vgs > Vth)
      vhigh_off: 3.00     # When device is OFF (Vgs < Vth)
    gate_control:
      vhigh_gc: 2.07
      vlow_gc: -2.07
    gate_bulk:
      vhigh_gb_on: "ap_no_check"
      vlow_gb_on: "-ap_no_check"
    junction:
      vfwd_jun_on: "ap_no_check"
      vrev_jun_on: -3.30
      vfwd_jun_off: "ap_no_check"
      vrev_jun_off: -3.30
    monitor_params:
      param: "vth"
      vgt: 0.0
    messages:
      vds: "AMR"
      vgs: "AMR"
      vgd: "AMR"
      vgb: "AMR"
      vsb: "AMR"
      vdb: "AMR"
    description: "Drain-source voltage depends on device on/off state"
  
  - name: "PMOS Core State Dependent"
    device: pmos_core
    parameter: "v[d,s]"
    type: state_dependent
    severity: high
    constraint:
      vhigh_on: 2.08
      vhigh_off: 3.00
    gate_control:
      vhigh_gc: 1.95
      vlow_gc: -1.95
    monitor_params:
      param: "vth"
      vgt: 0.0
      pmosvthsign: -1
    description: "Drain-source voltage depends on device on/off state"
  
  # High-Voltage with Aging Check
  - name: "PMOS 90V with HCI/TDDB Check"
    device: pmos90_10hv
    parameter: "v[d,s]"
    type: vhigh
    severity: high
    constraint:
      vhigh: 90
    aging_check:
      type: hci_tddb
      variant: atype
      params:
        soa_hcitddb_a: 24
        soa_hcitddb_b: 0.38
        soa_hcitddb_vdsref: -39.299
        soa_hcitddb_vgswc: -1.5006
        soa_hcitddb_tfac: 21098
        soa_hcitddb_tref: 298
        soa_hcitddb_wfac: 4.545
        soa_hcitddb_wref: 4.00e-05
    condition: "enable_soa == 1"
    description: "90V PMOS with aging reliability check"
  
  # Multi-Branch Rule
  - name: "NMOS 90V Multi-Branch"
    device: nmos90_10hv
    parameter: multi
    type: multi_branch
    severity: high
    branches:
      - branch: "V(g,b)"
        vhigh: "ap_gc_hv"
        vlow: "-ap_gc_hv"
      - branch: "V(g,s)"
        vhigh: "ap_gc_hv"
        vlow: "-ap_gc_hv"
      - branch: "V(g,d)"
        vhigh: "ap_gc_hv"
        vlow: -90
      - branch: "V(s,b)"
        vhigh: "ap_gc_hv"
        vlow: "-ap_fwd_hv"
      - branch: "V(d,b)"
        vhigh: 90
        vlow: "-ap_fwd_hv"
      - branch: "V(d,s)"
        vhigh: 90
        vlow: "-ap_gc_hv"
    connections: "(g b g s g d s b d b d s)"
    condition: "enable_soa == 1"
    description: "All voltage limits for 90V NMOS"
  
  # Resistor with Self-Heating
  - name: "Metal-1 Resistor with Self-Heating"
    device: rm1_10hv
    parameter: "i[rm1_10hv]"
    type: current_with_heating
    severity: high
    constraints:
      - name: "DC Current"
        type: idc
        ihigh: "$w * 4.05e-3"
        message: "Max. dc-current exceeded (violations are allowed for limited time)."
      - name: "Peak Current"
        type: ipeak
        ihigh: "$w * 4.05e-1"
        message: "Max. peak current exceeded (violations <100ns may be allowed)."
      - name: "RMS Current"
        type: irms
        ihigh: "1.0e-3 * sqrt(367.8 * $w * ($w + 0.53))"
        message: "Irms: self heating exceeds 5 degC."
    self_heating:
      dtmax: "dtmax_rm"
      theat: "theat"
      monitor: "shmonitor_nofeedback"
    device_params:
      weff1_soa: "$w - 0.04"
      rsh_soa: "nom_rs_m1*delr_rs_m1"
      leff_soa: "$l + dl_m1"
      jdc_rm: 4.05e-3
      jdc_rms: 367.8
      dw_rms: 0.53
      jpeak_rm: 4.05e-1
    condition: "enable_soa == 1"
    description: "Metal-1 resistor with DC, peak, and RMS current limits"
  
  # Oxide Risk Assessment
  - name: "NMOS Core Oxide Risk"
    device: nmos_core
    parameter: "v[g,b]"
    type: vhigh
    severity: review
    branches:
      - branch: "V(g,b)"
        vhigh: "ap_gc_lv_oxrisk"
        vlow: "-ap_gc_lv_oxrisk"
        message: "Vgb_OXrisk"
      - branch: "V(g,s)"
        vhigh: "ap_gc_lv_oxrisk"
        vlow: "-ap_gc_lv_oxrisk"
        message: "Vgs_OXrisk"
      - branch: "V(g,d)"
        vhigh: "ap_gc_lv_oxrisk"
        vlow: "-ap_gc_lv_oxrisk"
        message: "Vgd_OXrisk"
    condition: "enable_risk_assessment == 1"
    description: "Gate oxide risk assessment for core NMOS"
  
  - name: "NMOS 90V Oxide Risk"
    device: nmos90_10hv
    parameter: "v[g,b]"
    type: vhigh
    severity: review
    branches:
      - branch: "V(g,b)"
        vhigh: "ap_gc_hv_oxrisk"
        vlow: "-ap_gc_hv_oxrisk"
        message: "Vgb_OXrisk"
      - branch: "V(g,s)"
        vhigh: "ap_gc_hv_oxrisk"
        vlow: "-ap_gc_hv_oxrisk"
        message: "Vgs_OXrisk"
      - branch: "V(g,d)"
        vhigh: "ap_gc_hv_oxrisk"
        vlow: "-ap_gc_hv_oxrisk"
        message: "Vgd_OXrisk"
    condition: "enable_risk_assessment == 1"
    description: "Gate oxide risk assessment for 90V NMOS"
  
  # Capacitor Rules
  - name: "Low Voltage Capacitor"
    device: cap_low
    parameter: "v[t,nw]"
    type: vhigh
    severity: high
    constraint:
      vhigh: 1.65
      vlow: -1.65
    description: "Terminal-well voltage for low-voltage capacitor"
  
  - name: "Mid Voltage Capacitor"
    device: cap_mid
    parameter: "v[t,nw]"
    type: vhigh
    severity: high
    constraint:
      vhigh: 5.5
      vlow: -5.5
    description: "Terminal-well voltage for mid-voltage capacitor"
  
  - name: "Capacitor Substrate Check"
    device: cap_low
    parameter: "v[nw,sub]"
    type: vhigh
    severity: high
    constraint:
      vhigh: 120.0
      vlow: -70.0
    description: "Well-substrate voltage for capacitor"
  
  # Diode Rules
  - name: "N-type Diode Substrate"
    device: diode_n
    parameter: "v[n,sub]"
    type: vhigh
    severity: high
    constraint:
      vhigh: 120.0
      vlow: -70.0
    description: "N-region to substrate voltage"
  
  - name: "P-type Diode Substrate"
    device: diode_p
    parameter: "v[p,sub]"
    type: vhigh
    severity: high
    constraint:
      vhigh: 120.0
      vlow: -70.0
    description: "P-region to substrate voltage"
  
  # Range Constraints
  - name: "Reference Voltage Range"
    device: bandgap_ref
    parameter: "v[out]"
    type: range
    severity: high
    constraint:
      vlow: 1.15
      vhigh: 1.25
    description: "Bandgap reference output must stay within range"
  
  - name: "Temperature Sensor Range"
    device: temp_sensor
    parameter: "v[out]"
    type: range
    severity: medium
    constraint:
      vlow: "0.5 + 0.002*T"
      vhigh: "0.7 + 0.002*T"
    description: "Temperature sensor output range"
